create database OnthiCK
use OnthiCK
create table SINHVIEN
(
	MSSV CHAR(5) PRIMARY KEY,
	HOTENSV VARCHAR(40),
	GIOITINH VARCHAR(3),
	DIAHCI VARCHAR(50),
	DIENTHOAI VARCHAR(20),
	KHOA VARCHAR(4)

)
GO
CREATE TABLE MONHOC
(
	MAMH CHAR(4) PRIMARY KEY,
	TENMH VARCHAR(40),
	SOTC INT


)
GO
CREATE TABLE GIANGDAY
(
	MAKH CHAR(4) PRIMARY KEY,
	HOTENGV VARCHAR(40),
	MAMH CHAR(4),
	HOCKY TINYINT,
	NAM SMALLINT,
	NGBD SMALLDATETIME,
	NGKT SMALLDATETIME
)
GO
CREATE TABLE KETQUA
(
	MASV CHAR(5),
	MAKH CHAR(4),
	DIEM NUMERIC(4,2),
	NGTHI SMALLDATETIME,
	CONSTRAINT PK_KETQUA PRIMARY KEY (MASV,MAKH)
)

ALTER TABLE GIANGDAY ADD CONSTRAINT FK_GIANGDAY_MAMH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)
ALTER TABLE KETQUA ADD CONSTRAINT FK_KETQUA_MASV FOREIGN KEY (MASV) REFERENCES  SINHVIEN(MSSV)
ALTER TABLE KETQUA ADD CONSTRAINT FK_KETQUA_MAKH FOREIGN KEY (MAKH) REFERENCES GIANGDAY(MAKH)

INSERT INTO SINHVIEN(MSSV,HOTENSV,GIOITINH,DIAHCI,DIENTHOAI,KHOA) VALUES ('SV001','BUI THUY AN','NU','223','1','CNTT')
INSERT INTO SINHVIEN(MSSV,HOTENSV,GIOITINH,DIAHCI,DIENTHOAI,KHOA) VALUES ('SV002','NGUYEN THANH TUNG','NAM','140','2','CNTT')
INSERT INTO SINHVIEN(MSSV,HOTENSV,GIOITINH,DIAHCI,DIENTHOAI,KHOA) VALUES ('SV003','NGUYEN THANH LONG','NAM','112','3','TOAN')
INSERT INTO SINHVIEN(MSSV,HOTENSV,GIOITINH,DIAHCI,DIENTHOAI,KHOA) VALUES ('SV004','HOANG THI HOA','NU','90','4','CNTT')
INSERT INTO SINHVIEN(MSSV,HOTENSV,GIOITINH,DIAHCI,DIENTHOAI,KHOA) VALUES ('SV005','TRAN HONG SON','NAM','54','5','TOAN')

INSERT INTO MONHOC(MAMH,TENMH,SOTC) VALUES ('CSDL','CO SO DU LIEU','3')
INSERT INTO MONHOC(MAMH,TENMH,SOTC) VALUES ('CTDL','CAU TRUC DU LIEU','6')
INSERT INTO MONHOC(MAMH,TENMH,SOTC) VALUES ('KTLT','KY THUAT LAP TRINH','5')
INSERT INTO MONHOC(MAMH,TENMH,SOTC) VALUES ('CWIN','LAP TRINH C TREN WINDOW','4')

SET DATEFORMAT DMY
INSERT INTO GIANGDAY(MAKH,HOTENGV,MAMH,HOCKY,NAM,NGBD,NGKT) VALUES ('K1','GV01','CSDL','1','2016','03/09/2016','15/12/2016')
INSERT INTO GIANGDAY(MAKH,HOTENGV,MAMH,HOCKY,NAM,NGBD,NGKT) VALUES ('K2','GV04','KTLT','2','2016','22/01/2017','02/06/2017')
INSERT INTO GIANGDAY(MAKH,HOTENGV,MAMH,HOCKY,NAM,NGBD,NGKT) VALUES ('K3','GV03','CTDL','1','2017','03/09/2017','15/12/2017')
INSERT INTO GIANGDAY(MAKH,HOTENGV,MAMH,HOCKY,NAM,NGBD,NGKT) VALUES ('K4','GV04','CWIN','1','2017','03/09/2017','15/12/2017')
INSERT INTO GIANGDAY(MAKH,HOTENGV,MAMH,HOCKY,NAM,NGBD,NGKT) VALUES ('K5','GV01','CSDL','1','2017','03/09/2017','15/12/2017')
INSERT INTO GIANGDAY(MAKH,HOTENGV,MAMH,HOCKY,NAM,NGBD,NGKT) VALUES ('K6','GV01','KTLT','1','2017','03/09/2017','15/12/2017')

INSERT INTO KETQUA(MASV,MAKH,DIEM,NGTHI) VALUES ('SV001','K1','8.5','03/01/2017')
INSERT INTO KETQUA(MASV,MAKH,DIEM,NGTHI) VALUES ('SV002','K3','7.0','02/01/2018')
INSERT INTO KETQUA(MASV,MAKH,DIEM,NGTHI) VALUES ('SV003','K4','9.0','03/01/2018')
INSERT INTO KETQUA(MASV,MAKH,DIEM,NGTHI) VALUES ('SV001','K2','7.5','11/06/2017')
INSERT INTO KETQUA(MASV,MAKH,DIEM,NGTHI) VALUES ('SV004','K3','6.0','02/01/2018')
INSERT INTO KETQUA(MASV,MAKH,DIEM,NGTHI) VALUES ('SV005','K3','7.0','02/01/2018')
INSERT INTO KETQUA(MASV,MAKH,DIEM,NGTHI) VALUES ('SV002','K1','7.0','03/01/2017')
INSERT INTO KETQUA(MASV,MAKH,DIEM,NGTHI) VALUES ('SV003','K2','8.5','11/06/2017')
INSERT INTO KETQUA(MASV,MAKH,DIEM,NGTHI) VALUES ('SV005','K5','7.0','04/01/2018')
INSERT INTO KETQUA(MASV,MAKH,DIEM,NGTHI) VALUES ('SV004','K4','8.0','03/01/2018')
INSERT INTO KETQUA(MASV,MAKH,DIEM,NGTHI) VALUES ('SV004','K5','8.0','04/01/2018')
INSERT INTO KETQUA(MASV,MAKH,DIEM,NGTHI) VALUES ('SV004','K6','10.0','05/01/2018')

SELECT MSSV, HOTENSV, MAKH,DIEM FROM KETQUA, SINHVIEN WHERE MASV='SV003' AND KETQUA.MASV=SINHVIEN.MSSV ORDER BY MAKH ASC


SELECT HOCKY,HOTENGV, COUNT(MAKH) AS SOLUONGKH, NAM FROM GIANGDAY  GROUP BY HOCKY,NAM,HOTENGV

SELECT DISTINCT MAKH FROM GIANGDAY,MONHOC WHERE GIANGDAY.MAMH=MONHOC.MAMH AND HOTENGV='GV01' 
OR MAKH IN (SELECT DISTINCT MAKH FROM GIANGDAY,MONHOC WHERE SOTC >=5 AND GIANGDAY.MAMH=MONHOC.MAMH)

SELECT DISTINCT HOTENSV FROM SINHVIEN
WHERE NOT EXISTS 
( SELECT MAKH FROM GIANGDAY WHERE NAM='2016' 
	AND NOT EXISTS (SELECT MAKH FROM KETQUA WHERE KETQUA.MASV=SINHVIEN.MSSV AND KETQUA.MAKH=GIANGDAY.MAKH)
)

SELECT GIANGDAY.MAKH,HOTENGV FROM GIANGDAY, KETQUA
WHERE KETQUA.MAKH=GIANGDAY.MAKH GROUP BY GIANGDAY.MAKH,HOTENGV  
HAVING COUNT(MASV) >= ALL(SELECT COUNT(MASV) FROM KETQUA GROUP BY KETQUA.MAKH )





